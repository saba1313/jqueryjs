<html id="html">
<head>
<title>jQuery form.js Unit Test</title>

<!-- load latest build of jquery.js -->
<script type="text/javascript" src="../../../jquery/dist/jquery.js"></script>

<!-- load testrunner from jquery project -->
<script type="text/javascript" src="../../../jquery/test/data/testrunner.js"></script>

<!-- load form.js (this is what we're testing! -->
<script type="text/javascript" src="../form.js"></script>

<style>
body, div, h1 { font-family: 'trebuchet ms', verdana, arial; margin: 0; padding: 0 }
body { margin: 0; padding: 0; font-size: small; }
h1 { padding: 15px; margin: 0; font-size: large; background-color: #06b; color: white; border-bottom: 1px solid #ccc }
h2 { padding: 10px; background-color: #eee; color: black; margin: 0; font-size: small; font-weight: normal }

.pass { color: green; } 
.fail { color: red; } 
#tests ol { display: none; }
</style>

<script>
// run the tests when the doc is loaded
$(function() { runTest(function() {

    $('#userAgent').html(navigator.userAgent);

    // test serialization to array
    test("formToArray()", function() {
        var a = $("#form1").formToArray();
        ok( a.constructor == Array, "type check");
        ok( a.length == 13, "array length");
        ok( arrayCount(a, 'Multiple') == 3, "multi-select");
        ok( arrayValue(a, 'action') == 1, "input name=action");
        ok( arrayValue(a, 'method') == 2, "input name=method");
    });

    // test string serialization
    test("serialize()", function() {
        var s = $("#form1").serialize();
        ok( s.constructor == String, "type check");
        ok( s.split('&').length == 13, "string array length");
    });
    
    // test support for input elements not contained within a form
    test("pseudo form", function() {
        var s = $("#pseudo").serialize();
        ok( s.constructor == String, "type check");
        ok( s.split('&').length == 3, "string array length");
    });
    
    // test form with inputs named 'action' and 'method'
    test("form attrs", function() {
        var f = $("#form1");
        ok( f.attr('action').match('text.php'), "form 'action'");
        ok( f.attr('method') == 'post', "form 'method'");
    });
    
    // test ajaxSubmit semantic support
    test("semantic test", function() {
        var formData = $("#form2").formToArray(true);
        var testData = ['a','b','c','d','e','f'];
        for (var i=0; i < 6; i++) {
            ok(formData[i].name == testData[i], "match value at index="+i);
        }
    });

    // test ajaxSubmit target update
    test("ajaxSubmit1", function() {
        $('#targetDiv').html("");
        stop();
        $('#form3').ajaxSubmit('#targetDiv', function() { // post-callback
            ok( true, 'post-callback');
            ok( $('#targetDiv').text().match("Lorem ipsum"), "targetDiv updated");
            start();
        });
    });

    // test ajaxSubmit pre-submit callback
    test("ajaxSubmit2", function() {
        $('#form3').ajaxSubmit('#targetDiv', null, function(a, jq) { // pre-callback
            ok( true, 'pre-callback');
            ok( jq.attr('action').match('text.php'), "form 'action'");
            ok( jq.attr('method') == 'get', "form 'method'");
            ok( a.constructor == Array, "type check array");
            ok( jq.jquery, "type check jQuery");
            ok( jq[0].tagName.toLowerCase() == 'form', "jQuery arg == 'form'");
        });
    });

    // test ajaxSubmit post-submit callback for response and status text
    test("ajaxSubmit3", function() {
        stop();
        $('#form3').ajaxSubmit(function(responseText, statusText) { // post-callback
            ok( true, 'post-callback');
            ok( responseText.match("Lorem ipsum"), "responseText");
            ok( statusText == "success", "statusText");
            start();
        });
    });

    // test semantic support and url (action) override. passing no target and
    // no callback will cause the response string to be evaluated.
    // if the override of the form's action from text.php to json.php does
    // not work then the response from text.php will be evaled and that will
    // generate an error.
    test("ajaxSubmit4", function() {
        var testData = ['a','b','c','d','e','f'];

        $('#form2').ajaxSubmit(null, null, function(a, jq) { // pre-callback
            ok( true, 'pre-callback');
            ok( jq.attr('action').match('text.php'), "form 'action'");
            ok( jq.attr('method') == 'post', "form 'method'");
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
            for (var i=0; i < a.length; i++) {
                ok(a[i].name == testData[i], "match value at index="+i);
            }
        },
        'json.php',null,true); // semantic flag ==  true
    });

    // test ajaxSubmit using pre-submit callback to cancel submit
    test("ajaxSubmit5", function() {
        $('#form3').ajaxSubmit('#targetDiv', function() { // post-callback
            ok( false, "should not hit this post-callback");
        },
        function(a, jq) { // pre-callback
            ok( true, 'pre-callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
            return false;  // return false to abort submit
        });
    });

    // test submitting a pseudo-form
    test("ajaxSubmit6", function() {
        stop();
        $("#pseudo").ajaxSubmit('#targetDiv', function() { // post-callback
            ok( true, 'post-callback');
            start();
        },
        function(a, jq) { // pre-callback
            ok( true, 'pre-callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
            ok( jq[0].tagName.toLowerCase() == 'div', "jQuery arg == 'div'");
        },
        'text.php', 'post');
    });

    // test eval of json response
    test("ajaxSubmit7", function() {
        stop();
        
        $("#form2").ajaxSubmit(null, function(responseText) { // post-callback
            ok( true, 'post-callback');
            var data = eval.call(window, '('+responseText+')');
            ok( data.name == 'jquery-test', 'evaled respone');
            start();
        },
        null, 'json.php');
    });

    // test passing jQuery object as the target
    test("ajaxSubmit8", function() {
        stop();
        var target = $('#targetDiv');
        target.html("");
        
        $("#form2").ajaxSubmit(target, function(responseText) { // post-callback
            ok( true, 'post-callback');
            ok( $('#targetDiv').text().match("Lorem ipsum"), "targetDiv updated");
            start();
        });
    });

    // test passing DOM element as the target
    test("ajaxSubmit9", function() {
        stop();
        var target = $('#targetDiv');
        target.html("");
        
        $("#form2").ajaxSubmit(target[0], function(responseText) { // post-callback
            ok( true, 'post-callback');
            ok( $('#targetDiv').text().match("Lorem ipsum"), "targetDiv updated");
            start();
        });
    });

    // test pre and post callbacks for ajaxForm
    test("ajaxForm1", function() {
        stop();
        $("#form4").ajaxForm('#targetDiv', function() {
            ok( true, 'post-callback');
            start();
        },
        function(a, jq) {
            ok( true, 'pre-callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
        });
        $('#doSubmit')[0].click();
    });

    // test that the value of the submit button is captured
    test("ajaxForm2", function() {
        $("#form4").ajaxForm(null, null, function(a, jq) {
            ok( true, 'pre-callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
            ok( arrayValue(a, 'myName') != null, "submit button");
        });
        $('#mySubmit')[0].click();
    });
    
    // test image submit support
    test("ajaxForm3", function() {
        $("#form4").ajaxForm('#targetDiv', null, function(a, jq) { // pre-callback
            ok( true, 'pre-callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
            ok( arrayValue(a, 'myImage_x') != null, "x coord");
            ok( arrayValue(a, 'myImage_y') != null, "y coord");
        });
        $('#imageSubmit')[0].click();
    });

    // test that the targetDiv gets updated
    test("ajaxForm4", function() {
        $('#targetDiv').html("");
        stop();
        $("#form4").ajaxForm('#targetDiv', function() {
            ok( true, 'post-callback');
            ok( $('#targetDiv').text().match("Lorem ipsum"), "targetDiv updated");
            start();
        },
        function(a, jq) {
            ok( true, 'pre-callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
        });
        $('#doSubmit')[0].click();
    });

})});

// helper method   
function arrayCount(arr, key) {
    var count=0;
    for (var i=0; i < arr.length; i++) {
        if (arr[i].name == key) 
            count++;
    }
    return count;
}

// helper method   
function arrayValue(arr, key) {
    for (var i=0; i < arr.length; i++) {
        if (arr[i].name == key)
            return arr[i].value;
    }
}
</script>
</head>
<body id="body">
	<h1 id="banner">jQuery form.js - Test Suite</h1>
	<h2 id="userAgent"></h2>
    
	<!-- Test HTML -->
	<div id="main" style="display: none;">

        <!-- form1 -->
        <form id="form1" action="text.php" method="post"><div>
                <input type="hidden" name="Hidden" value="hiddenValue" />
                <input name="Name" type="text" value="MyName1" />
                <input name="Password" type="password" />
                <select name="Multiple" multiple="multiple">
                    <optgroup label="block 1">
                        <option value="one" selected="selected">One</option>
                        <option value="two">Two</option>
                        <option value="three">Three</option>
                    </optgroup>
                    <optgroup label="block 2">
                        <option value="four" selected="selected">Four</option>
                        <option value="five">Five</option>
                        <option value="six" selected="selected">Six</option>
                    </optgroup>
                </select>
                <select name="Single">
                    <option value="one" selected="selected">One</option>
                    <option value="two">Two</option>
                    <option value="three">Three</option>
                </select>
                <select name="Single2">
                    <optgroup label="block 3">
                        <option value="A" selected="selected">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </optgroup>
                    <optgroup label="block 3">
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                    </optgroup>
                </select>
                <input type="checkbox" name="Check" value="1" />
                <input type="checkbox" name="Check" value="2" checked="checked" />
                <input type="checkbox" name="Check" value="3" />
                <input type="radio" name="Radio" value="1" />
                <input type="radio" name="Radio" value="2" checked="checked" />
                <input type="radio" name="Radio" value="3" />
                <input type="text" name="action" value="1" />
                <input type="text" name="method" value="2" />
                <textarea name="Text" rows="2" cols="20">This is Form1</textarea>
                <input type="submit"  name="submitButton" value="Submit1" />
                <input type="submit"  name="submitButton" value="Submit2" />
                <input type="submit"  name="submitButton" value="Submit3" />
                <input type="image"   name="submitButton" value="Submit4" src="submit.gif" />
                <input type="reset"   name="resetButton " value="Reset" />
        </div></form>

        <!-- form2 -->
        <form id="form2" action="text.php" method="post"><div>
            <input    name="a" type="text" />
            <textarea name="b" rows="1" cols="1"></textarea>
            <input    name="c" type="text" />
            <select   name="d"><option value="x">x</option></select>
            <textarea name="e" rows="1" cols="1"></textarea>
            <input    name="f" type="text" />
            <input type="reset"   name="resetButton " value="Reset" />
        </div></form>

        <!-- form3 -->
        <form id="form3" action="text.php" method="get"><div>
            <input name="a" type="text" />
        </div></form>

        <!-- form4 -->
        <form id="form4" action="text.php" method="get"><div>
            <input name="a" type="text" />
            <input type="submit" id="doSubmit" />
            <input type="submit" id="mySubmit" name="myName" />
            <input type="image"  id="imageSubmit" name="myImage" src="submit.gif" />
        </div></form>

        <!-- pseudo-form -->
        <div id="pseudo">
            <input name="a" type="text" />
            <input type="checkbox" name="Check" value="1" />
            <input type="checkbox" name="Check" value="2" checked="checked" />
            <select name="Select">
                <option value="opt1" />
                <option value="opt2" selected="selected" />
            </select>
            <input type="submit" value="button" /></button>
        </div>

        <div id="targetDiv"></div>
	</div>
	
	<ol id="tests"></ol>
</body>
</html>
