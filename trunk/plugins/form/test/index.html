<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>jQuery form.js Unit Test</title>

<!-- load latest build of jquery.js -->
<script type="text/javascript" src="../../../jquery/dist/jquery.js"></script>

<!-- load testrunner from jquery project -->
<script type="text/javascript" src="../../../jquery/test/data/testrunner.js"></script>

<!-- load form.js (this is what we're testing! -->
<script type="text/javascript" src="../form.js"></script>

<link rel="Stylesheet" media="screen" href="../../../jquery/test/data/testsuite.css" />

<script>
// test form with inputs named 'action' and 'method'
test("'action' and 'method' form attributes", function() {
	expect(2);
    var f = $("#form1");
    ok( f.attr('action').match('text.php'), "form 'action'");
    ok( f.attr('method').match('get'), "form 'method'");
});

// test serialization to array
test("formToArray: multi-select", function() {
	expect(3);
    var a = $("#form1").formToArray();
    ok( a.constructor == Array, "type check");
    ok( a.length == 13, "array length");
    ok( arrayCount(a, 'Multiple') == 3, "multi-select");
});

// test serialization to array
test("formToArray: 'action' and 'method' inputs", function() {
	expect(3);
    var a = $("#form1").formToArray();
    ok( a.constructor == Array, "type check");
    ok( arrayValue(a, 'action') == 1, "input name=action");
    ok( arrayValue(a, 'method') == 2, "input name=method");
});

// test formToArray semantic support
test("formToArray: semantic test", function() {
	expect(6);
    var formData = $("#form2").formToArray(true);
    var testData = ['a','b','c','d','e','f'];
    for (var i=0; i < 6; i++) {
        ok(formData[i].name == testData[i], "match value at index="+i);
    }
});

// test string serialization
test("serialize: param count", function() {
	expect(2);
    var s = $("#form1").formSerialize();
    ok( s.constructor == String, "type check");
    ok( s.split('&').length == 13, "string array length");
});

// test support for input elements not contained within a form
test("serialize: pseudo form", function() {
	expect(2);
    var s = $("#pseudo").formSerialize();
    ok( s.constructor == String, "type check");
    ok( s.split('&').length == 3, "string array length");
});

// test ajaxSubmit target update
test("ajaxSubmit: target == String", function() {
	expect(2);
    $('#targetDiv').empty();
    stop();
    
    var opts = {
        target: '#targetDiv',
        after: function() { // post-callback
            ok( true, 'post-callback');
            ok( $('#targetDiv').text().match("Lorem ipsum"), "targetDiv updated");
            start();
        }
    };
    $('#form3').ajaxSubmit(opts);
});

// test passing jQuery object as the target
test("ajaxSubmit: target == jQuery object", function() {
	expect(2);
    stop();
    var target = $('#targetDiv');
    target.empty();
    
    var opts = {
        target: target,
        after: function(responseText) { // post-callback
            ok( true, 'post-callback');
            ok( $('#targetDiv').text().match("Lorem ipsum"), "targetDiv updated");
            start();
        }
    };
    
    $("#form2").ajaxSubmit(opts);
});

// test passing DOM element as the target
test("ajaxSubmit: target == DOM element", function() {
	expect(2);
    stop();
    $('#targetDiv').empty();
    var target = $('#targetDiv')[0];
    
    var opts = {
        target: target,
        after: function(responseText) { // post-callback
            ok( true, 'post-callback');
            ok( $('#targetDiv').text().match("Lorem ipsum"), "targetDiv updated");
            start();
        }
    };
    
    $("#form2").ajaxSubmit(opts);
});



// test ajaxSubmit pre-submit callback
test("ajaxSubmit: pre-submit callback", function() {
	expect(4);
    var opts = {
        before: function(a, jq) { // pre-submit callback
            ok( true, 'pre-submit callback');
            ok( a.constructor == Array, "type check array");
            ok( jq.jquery, "type check jQuery");
            ok( jq[0].tagName.toLowerCase() == 'form', "jQuery arg == 'form'");
        }
    };

    $('#form3').ajaxSubmit(opts);
});

// test ajaxSubmit post-submit callback for response and status text
test("ajaxSubmit: post-submit callback", function() {
	expect(3);
    stop();

    var opts = {
        after: function(responseText, statusText) { // post-submit callback
            ok( true, 'post-submit callback');
            ok( responseText.match("Lorem ipsum"), "responseText");
            ok( statusText == "success", "statusText");
            start();
        }
    };

    $('#form3').ajaxSubmit(opts);
});

// test semantic support via ajaxSubmit's pre-submit callback
test("ajaxSubmit: semantic test", function() {
	expect(9);
    var testData = ['a','b','c','d','e','f'];

    var opts = {
        semantic: true,
        before: function(a, jq) { // pre-submit callback
            ok( true, 'pre-submit callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
            for (var i=0; i < a.length; i++) {
                ok(a[i].name == testData[i], "match value at index="+i);
            }
        }
    };

    $('#form2').ajaxSubmit(opts);
});

// test json datatype
test("ajaxSubmit: dataType == json", function() {
	expect(2);
    stop();

    var opts = {
        url: 'json.txt',
        dataType: 'json',
        after: function(data, statusText) { // post-submit callback
            // assert that the json data was evaluated
            ok( typeof data == 'object', 'json data type');
            ok( data.name == 'jquery-test', 'json data contents');
            start();
        }
    };

    $('#form2').ajaxSubmit(opts);
});

// test script datatype
test("ajaxSubmit: dataType == script", function() {
	expect(2);
    stop();

    var opts = {
        url: 'script.txt?' + new Date().getTime(), // don't let ie cache it
        dataType: 'script',
        after: function(responseText, statusText) { // post-submit callback
            ok( typeof formScriptTest == 'function', 'script evaluated');
            ok( responseText.match('formScriptTest'), 'script returned');
            start();
        }
    };

    $('#form2').ajaxSubmit(opts);
});

// test xml datatype
test("ajaxSubmit: dataType == xml", function() {
	expect(2);
    stop();

    var opts = {
        url: 'test.xml',
        dataType: 'xml',
        after: function(responseXML, statusText) { // post-submit callback
            ok( typeof responseXML == 'object', 'data type xml');
            ok( $('test', responseXML).size() == 3, 'xml data query');
            start();
        }
    };

    $('#form2').ajaxSubmit(opts);
});

// test that args embedded in the action are honored; no real way
// to assert this so successful callback is used to signal success
test("ajaxSubmit: existing args in action attr", function() {
	expect(1);
    stop();

    var opts = {
        after: function() { // post-submit callback
            ok( true, 'post callback');
            start();
        }
    };

    $('#form5').ajaxSubmit(opts);
});

// test ajaxSubmit using pre-submit callback to cancel submit
test("ajaxSubmit: cancel submit", function() {
	expect(3);

    var opts = {
        before: function(a, jq) { // pre-submit callback
            ok( true, 'pre-submit callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
            return false;  // return false to abort submit
        },
        after: function() { // post-submit callback
            ok( false, "should not hit this post-submit callback");
        }
    };

    $('#form3').ajaxSubmit(opts);
});

// test submitting a pseudo-form
test("ajaxSubmit: pseudo-form", function() {
	expect(5);
    stop();

    var opts = {
        before: function(a, jq) { // pre-submit callback
            ok( true, 'pre-submit callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
            ok( jq[0].tagName.toLowerCase() == 'div', "jQuery arg == 'div'");
        },
        after: function() { // post-submit callback
            ok( true, 'post-submit callback');
            start();
        },
        // url and method must be provided for a pseudo form since they can
        // not be extracted from the markup
        url: 'text.php',
        method: 'post'
    };

    $("#pseudo").ajaxSubmit(opts);
});

// test eval of json response
test("ajaxSubmit: evaluate response", function() {
	expect(2);
    stop();
    
    var opts = {
        after: function(responseText) { // post-callback
            ok( true, 'post-callback');
            var data = eval.call(window, '('+responseText+')');
            ok( data.name == 'jquery-test', 'evaled respone');
            start();
        },
        url: 'json.txt'
    };
    
    $("#form2").ajaxSubmit(opts);
});

// test pre and post callbacks for ajaxForm
test("ajaxForm: pre and post callbacks", function() {
	expect(4);
    stop();

    var opts = {
        before: function(a, jq) { // pre-submit callback
            ok( true, 'pre-submit callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
        },
        after: function() { // post-submit callback
            ok( true, 'post-submit callback');
            start();
        }
    };

    $("#form4").ajaxForm(opts);
    $('#submitForm4')[0].click();  // trigger the submit button
});

// test that the value of the submit button is captured
test("ajaxForm: capture submit element", function() {
	expect(4);

    var opts = {
        before: function(a, jq) { // pre-callback
            ok( true, 'pre-callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
            ok( arrayValue(a, 'form4inputName') != null, "submit button");
        }
    };

    $("#form4").ajaxForm(opts);
    $('#submitForm4withName')[0].click();
});

// test image submit support
test("ajaxForm: capture submit image coordinates", function() {
	expect(5);

    var opts = {
        before: function(a, jq) { // pre-callback
            ok( true, 'pre-callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
            ok( arrayValue(a, 'myImage_x') != null, "x coord");
            ok( arrayValue(a, 'myImage_y') != null, "y coord");
        }
    };

    $("#form4").ajaxForm(opts);
    $('#form4imageSubmit')[0].click();
});

// test that the targetDiv gets updated
test("ajaxForm: update target div", function() {
	expect(5);
    $('#targetDiv').empty();
    stop();

    var opts = {
        target: '#targetDiv',
        before: function(a, jq) { // pre-callback
            ok( true, 'pre-callback');
            ok( a.constructor == Array, "type check");
            ok( jq.jquery, "type check jQuery");
        },
        after: function() {
            ok( true, 'post-callback');
            ok( $('#targetDiv').text().match("Lorem ipsum"), "targetDiv updated");
            start();
        }
    };

    $("#form4").ajaxForm(opts);
    $('#submitForm4')[0].click();
});

test("'success' callback", function() {
	expect(1);
    $('#targetDiv').empty();
    stop();

    var opts = {
        success: function() {
            ok( true, 'post-callback');
            start();
        }
    };

    $('#form3').ajaxSubmit(opts);
});

test("'error' callback", function() {
	expect(1);
    $('#targetDiv').empty();
    stop();

    var opts = {
        url: 'bogus.php',
        error: function() {
            ok( true, 'error-callback');
            start();
        },
        after: function() { // post-submit callback
            ok( false, "should not hit post-submit callback");
        }
    };

    $('#form3').ajaxSubmit(opts);
});

// helper method   
function arrayCount(arr, key) {
    var count=0;
    for (var i=0; i < arr.length; i++) {
        if (arr[i].name == key) 
            count++;
    }
    return count;
}

// helper method   
function arrayValue(arr, key) {
    for (var i=0; i < arr.length; i++) {
        if (arr[i].name == key)
            return arr[i].value;
    }
}
</script>
</head>
<body id="body">
	<h1 id="banner">jQuery form.js - Test Suite</h1>
	<h2 id="banner"></h2>
	<h2 id="userAgent"></h2>
    
	<!-- Test HTML -->
	<div id="main" style="display: none;">

        <!-- form1 -->
        <form id="form1" action="text.php" method="get"><div>
                <input type="hidden" name="Hidden" value="hiddenValue" />
                <input name="Name" type="text" value="MyName1" />
                <input name="Password" type="password" />
                <select name="Multiple" multiple="multiple">
                    <optgroup label="block 1">
                        <option value="one" selected="selected">One</option>
                        <option value="two">Two</option>
                        <option value="three">Three</option>
                    </optgroup>
                    <optgroup label="block 2">
                        <option value="four" selected="selected">Four</option>
                        <option value="five">Five</option>
                        <option value="six" selected="selected">Six</option>
                    </optgroup>
                </select>
                <select name="Single">
                    <option value="one" selected="selected">One</option>
                    <option value="two">Two</option>
                    <option value="three">Three</option>
                </select>
                <select name="Single2">
                    <optgroup label="block 3">
                        <option value="A" selected="selected">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </optgroup>
                    <optgroup label="block 3">
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                    </optgroup>
                </select>
                <input type="checkbox" name="Check" value="1" />
                <input type="checkbox" name="Check" value="2" checked="checked" />
                <input type="checkbox" name="Check" value="3" />
                <input type="radio" name="Radio" value="1" />
                <input type="radio" name="Radio" value="2" checked="checked" />
                <input type="radio" name="Radio" value="3" />
                <input type="text" name="action" value="1" />
                <input type="text" name="method" value="2" />
                <textarea name="Text" rows="2" cols="20">This is Form1</textarea>
                <input type="submit"  name="submitButton" value="Submit1" />
                <input type="submit"  name="submitButton" value="Submit2" />
                <input type="submit"  name="submitButton" value="Submit3" />
                <input type="image"   name="submitButton" value="Submit4" src="submit.gif" />
                <input type="reset"   name="resetButton " value="Reset" />
        </div></form>

        <!-- form2 -->
        <form id="form2" action="text.php" method="get"><div>
            <input    name="a" type="text" />
            <textarea name="b" rows="1" cols="1"></textarea>
            <input    name="c" type="text" />
            <select   name="d"><option value="x">x</option></select>
            <textarea name="e" rows="1" cols="1"></textarea>
            <input    name="f" type="text" />
            <input type="reset"   name="resetButton " value="Reset" />
        </div></form>

        <!-- form3 -->
        <form id="form3" action="text.php" method="post"><div>
            <input name="a" type="text" />
        </div></form>

        <!-- form4 -->
        <form id="form4" action="text.php" method="get"><div>
            <input name="a" type="text" />
            <input type="submit" id="submitForm4" />
            <input type="submit" id="submitForm4withName" name="form4inputName" />
            <input type="image"  id="form4imageSubmit" name="myImage" src="submit.gif" />
        </div></form>

        <!-- form5 -->
        <form id="form5" action="text.php?test=form" method="get"><div>
            <input name="a" type="text" />
            <input type="submit" />
            <input type="submit" name="form5inputName" />
            <input type="image"  name="myImage" src="submit.gif" />
        </div></form>

        <!-- pseudo-form -->
        <div id="pseudo">
            <input name="a" type="text" />
            <input type="checkbox" name="Check" value="1" />
            <input type="checkbox" name="Check" value="2" checked="checked" />
            <select name="Select">
                <option value="opt1" />
                <option value="opt2" selected="selected" />
            </select>
            <input type="submit" value="button" />
        </div>

        <div id="targetDiv"></div>
	</div>
	
	<ol id="tests"></ol>
</body>
</html>
